<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description"
    content="Comprueba tu código promocional de La Casera para el Mundial 2026 y gana premios de la Selección Española.">
  <meta name="theme-color" content="#D2001E">
  <title>La Casera · Mundial 2026 - Comprueba tu código</title>
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <!-- Hero Image -->
  <div class="hero-container">
    <img src="estilos/FONDO NUEVO ROJA1.png" alt="La Casera Mundial 2026" class="hero-image">
  </div>

  <!-- Main Content -->
  <main class="container bottom-drawer" role="main" id="formContainer">
    <!-- Bottom Tab Trigger (Inside container) -->
    <button id="bottomTabBtn" class="bottom-tab-btn" aria-expanded="false" aria-controls="formContainer">
      Comprueba tu código promocional <span class="arrow-icon">↑</span>
    </button>
    <header>
      <h1>Comprueba tu código promocional</h1>

    </header>

    <!-- Promotional Form -->
    <form action="#" method="POST" class="promo-form" novalidate>


      <div class="input-group">
        <label for="codigo" class="visually-hidden">Código promocional</label>
        <input type="text" id="codigo" name="codigo" placeholder="CÓDIGO *" required autocomplete="off"
          aria-required="true" aria-describedby="codigoHelp">
        <div id="codigoHelp" class="visually-hidden">Introduce el código que aparece en tu envase de La Casera.</div>
      </div>

      <!-- Terms & Conditions -->
      <fieldset class="checkbox-group">
        <legend
          style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border-width: 0;">
          Aceptaciones requeridas</legend>
        <label class="checkbox-container">
          <input type="checkbox" name="mayor_edad" required aria-label="Confirmo que soy mayor de 16 años">
          <span class="checkmark"></span>
          Soy mayor de 18 años
        </label>

        <label class="checkbox-container">
          <input type="checkbox" name="bases_legales" required aria-label="He leído y acepto las bases legales">
          <span class="checkmark"></span>
          He leído y acepto las&nbsp;<a href="bases-legales.html" target="_blank" rel="noopener noreferrer">bases
            legales</a>.
        </label>
      </fieldset>

      <button type="submit" class="submit-btn" id="submitBtn">Enviar →</button>
    </form>
    <footer style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--gray-medium);">
      <p style="text-align: center; font-size: 0.85rem;">
        <a href="bases-legales.html" target="_blank">Bases Legales</a> |
        <a href="politica-privacidad.html" target="_blank">Política de Privacidad</a> |
        <a href="politica-cookies.html" target="_blank">Política de Cookies</a>
      </p>
    </footer>
  </main>



  <!-- Result Modal -->
  <div class="modal-overlay" id="resultModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle"
    aria-hidden="true">
    <div class="modal-content">
      <h2 id="modalTitle">Resultado</h2>
      <p id="modalMessage">Mensaje del resultado</p>
      <button class="close-modal" id="closeModal" aria-label="Cerrar modal">Cerrar</button>
    </div>
  </div>



  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const tabBtn = document.getElementById('bottomTabBtn');
      const container = document.getElementById('formContainer');
      const arrow = tabBtn.querySelector('.arrow-icon');

      if (tabBtn && container) {
        tabBtn.addEventListener('click', () => {
          const isOpen = container.classList.toggle('open');
          tabBtn.setAttribute('aria-expanded', isOpen);

          if (isOpen) {
            arrow.textContent = '↓';
            tabBtn.classList.add('active');
          } else {
            arrow.textContent = '↑';
            tabBtn.classList.remove('active');
          }
        });

        // Optional: Close when clicking outside (on the overlay mostly)
        // Since the container covers almost everything when open, this might be tricky to implement purely based on "outside" 
        // without an explicit overlay element. For now, the button toggles it.
      }

      const form = document.querySelector('.promo-form');
      const modalTitle = document.getElementById('modalTitle');
      const modalMessage = document.getElementById('modalMessage');
      const closeModal = document.getElementById('closeModal');

      // Close modal and reset input (with focus return)
      let _previousFocus = null;
      let _onKeyDown = null;

      function closeAndReset() {
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
        if (_onKeyDown) document.removeEventListener('keydown', _onKeyDown);
        const codigoInput = document.getElementById('codigo');
        codigoInput.value = '';
        if (_previousFocus && typeof _previousFocus.focus === 'function') {
          _previousFocus.focus();
        } else {
          codigoInput.focus();
        }
      }

      // Close modal event
      closeModal.addEventListener('click', closeAndReset);

      // Close on click outside
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeAndReset();
        }
      });

      // Cookie Banner Logic
      const cookieBanner = document.getElementById('cookieBanner');
      const acceptCookiesBtn = document.getElementById('acceptCookies');
      const rejectCookiesBtn = document.getElementById('rejectCookies');

      // Use a versioned key to force it to show for users who might have old data or for testing
      const COOKIE_KEY = 'cookiesAccepted_v1';

      if (!localStorage.getItem(COOKIE_KEY)) {
        cookieBanner.classList.add('visible');
      }

      acceptCookiesBtn.addEventListener('click', () => {
        localStorage.setItem(COOKIE_KEY, 'true');
        cookieBanner.classList.remove('visible');
      });

      rejectCookiesBtn.addEventListener('click', () => {
        localStorage.setItem(COOKIE_KEY, 'rejected');
        cookieBanner.classList.remove('visible');
      });


      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const codigoInput = document.getElementById('codigo');
        const codigo = codigoInput.value.trim();

        if (!codigo) {
          return; // HTML5 'required' should handle this, but double check
        }

        // Verificar que ambas casillas estén seleccionadas
        const mayorEdad = document.querySelector('input[name="mayor_edad"]').checked;
        const basesLegales = document.querySelector('input[name="bases_legales"]').checked;

        if (!mayorEdad || !basesLegales) {
          showModal('ATENCIÓN', 'Debes ser mayor de 16 años y aceptar las bases legales para continuar.');
          return;
        }

        try {
          const response = await fetch('https://lacasera-backend.onrender.com/api/check-code', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ code: codigo })
          });

          const data = await response.json();

          if (!data.success) {
            // Si success es false, mostramos el mensaje de error (ej: código no válido o ya usado)
            showModal('ATENCIÓN', data.message);
          } else if (data.isPrize) {
            // ¡Premio! Guardamos el código para la siguiente página
            localStorage.setItem('winningCode', codigo);
            window.location.href = 'premio.html';
          } else {
            showModal('NO PREMIADO', 'Código no premiado, vuelva a intentarlo con otro código.');
          }

        } catch (error) {
          console.error('Error:', error);
          showModal('ERROR', 'Hubo un problema al verificar el código. Inténtalo de nuevo más tarde.');
        }
      });

      function showModal(title, message) {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        // Accessibility: save focus, show modal, set aria-hidden, trap focus, handle Escape
        _previousFocus = document.activeElement;
        modal.setAttribute('aria-hidden', 'false');
        modal.classList.add('active');

        // Find focusable elements inside modal
        const focusable = modal.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])');
        const focusableArr = Array.prototype.slice.call(focusable);
        const firstFocusable = focusableArr[0];
        const lastFocusable = focusableArr[focusableArr.length - 1];

        // Focus the close button for immediate keyboard access
        if (closeModal) closeModal.focus();

        _onKeyDown = function (e) {
          if (e.key === 'Escape') {
            e.preventDefault();
            closeAndReset();
            return;
          }

          if (e.key === 'Tab' && focusableArr.length > 0) {
            // Trap focus within modal
            if (e.shiftKey) { // shift + tab
              if (document.activeElement === firstFocusable) {
                e.preventDefault();
                lastFocusable.focus();
              }
            } else { // tab
              if (document.activeElement === lastFocusable) {
                e.preventDefault();
                firstFocusable.focus();
              }
            }
          }
        };

        document.addEventListener('keydown', _onKeyDown);
      }
    });
  </script>

</html>